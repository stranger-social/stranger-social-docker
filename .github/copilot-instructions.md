# GitHub Copilot Instructions for mastodon-docker

This file provides context and guidelines for GitHub Copilot when working with this Mastodon Docker deployment repository.

## Project Status

**Current Version:** 5.0.2  
**Iteration:** 5th generation of stranger-social Mastodon deployment  
**Last Updated:** October 24, 2025

See `docs/CHANGELOG.md` for version history and changes.

## Project Overview

This is a **provider-agnostic, production-ready Docker Compose setup** for deploying Mastodon on any cloud provider or on-premises infrastructure. The repository is designed for ease of setup, maintenance, and customization.

## Key Principles

1. **Provider-Agnostic**: Code and configs must work on AWS, Linode, DigitalOcean, Azure, GCP, self-hosted, etc.
2. **Security-First**: Secrets are never committed; use environment variables and `.env.example`
3. **Documentation-Driven**: All operational docs live in `docs/` (Wiki format, auto-synced to GitHub Wiki)
4. **Minimal Scope**: Repository contains only deployment configs and documentation; large scripts should be simple and well-commented

## Architecture

```
mastodon-docker/
├── docker-compose.yml          # Service definitions (web, streaming, sidekiq, redis, postgres, nginx)
├── .env.example                # Configuration template
├── nginx/                      # Reverse proxy configuration
│   ├── nginx.conf
│   └── conf.d/default.conf     # Virtual host (use example.com placeholder, not instance-specific)
├── certbot/                    # SSL certificate structure (certs not tracked)
│   ├── conf/                   # Generated by certbot; keep .gitkeep only
│   └── www/                    # ACME validation directory
├── docs/                       # Wiki documentation (auto-synced to GitHub Wiki)
│   ├── Home.md                 # Quick start & deployment guide
│   └── MCP.md                  # GitHub MCP usage guide
├── .github/workflows/          # CI/CD automation
│   ├── sync-wiki.yml          # Auto-sync docs/ to GitHub Wiki
│   └── secret-scan.yml        # Prevent accidental secret commits
├── mastodon.service            # Systemd unit file
├── setup.sh                    # Initial setup (if present)
├── maintenance.sh              # Common operations (if present)
└── validate.sh                 # Pre-flight validation (if present)
```

## Services in docker-compose.yml

- **web**: Mastodon Rails app (Puma) on port 3000
- **streaming**: Node.js WebSocket server on port 4000
- **sidekiq**: Job queue (default, ingress, push, pull)
- **redis**: Cache & job store on port 6379
- **postgres**: PostgreSQL 15 on port 5432
- **nginx**: Reverse proxy on ports 80/443

All services use `.env` for configuration; no hardcoded credentials.

## Configuration Rules

### `.env` Handling
- **Never committed** (protected by `.gitignore`)
- Users copy `.env.example` to `.env` and customize
- Example:
  ```bash
  cp .env.example .env
  nano .env  # Fill in your domain, S3 bucket, SMTP, etc.
  ```

### Environment Variables
- Use `${VARIABLE_NAME}` syntax in docker-compose.yml
- Parameterize paths:
  - `DB_DATA_DIR` for flexible volume mounting (not hardcoded `/mnt/stranger_social_*`)
  - `LOCAL_DOMAIN` for reverse proxy vhost names
- S3/Storage: Support provider-agnostic endpoints (AWS, Linode Objects, MinIO)
- SMTP: Generic (e.g., `smtp.gmail.com`, or user's mail provider)

### Nginx Configuration
- Use `stranger.social` as the domain
- Proxy upstreams: `http://web:3000`, `http://streaming:4000` (use container names)
- Healthcheck: reference `${LOCAL_DOMAIN}` or `localhost`
- SSL paths: `/etc/letsencrypt/live/stranger.social/` (certbot will place real certs at runtime)

## Code Style & Patterns

### Docker Compose
- Use environment variables from `.env` for all secrets and config
- Remove `.env.production` references (merge into `.env`)
- Health checks on all services
- Use Alpine/slim images where possible (smaller footprint)
- Pin image versions (e.g., `ghcr.io/mastodon/mastodon:v4.4.8`, not `latest`)

### Scripts
- Bash scripts: POSIX-compatible, well-commented
- No hardcoded domain names, paths, or credentials
- Use `${VARIABLE}` for config substitution
- Exit codes: 0 for success, 1 for errors

### Documentation
- Markdown format in `docs/`
- Focus on "how to deploy" and "how to operate," not specific provider walkthroughs
- Examples use `stranger.social` as the domain
- Link to external docs (Mastodon, Docker, certbot) rather than duplicating them
- Include troubleshooting and common issues

### Git Commit Messages
- Clear, concise messages
- Reference issues if applicable (e.g., "Fix #42")
- Format: `<action>: <description>` (e.g., "docs: add troubleshooting section", "ci: add secret scanner")

## Security Best Practices

1. **No Secrets in Repo**
   - CI job (`secret-scan.yml`) scans for leaked credentials
   - Catches: SECRET_KEY_BASE, OTP_SECRET, AWS keys, SMTP passwords, etc.
   - Fails the build if `.env` is committed

2. **Certbot Files**
   - Generated SSL certs/configs never committed
   - Directory structure preserved with `.gitkeep` for first-time clones
   - CI fails if any certbot-generated files are staged

3. **Example Configs**
   - `.env.example` contains placeholders only
   - `nginx/conf.d/default.conf` uses `stranger.social`
   - `docker-compose.yml` uses generic provider placeholders

4. **Version Pinning**
   - Docker images pinned to stable versions
   - No `latest` tags
   - Security updates coordinated with Mastodon releases

## Common Tasks & How Copilot Can Help

### Adding a New Service
- Update `docker-compose.yml` with proper healthcheck, logging, volumes
- Ensure image is pinned to a stable version
- Add environment variables to `.env.example`
- Document in `docs/Home.md` if user-facing

### Updating Documentation
- Write in `docs/` folder (not root `.md` files)
- Use generic examples, not instance-specific domains/paths
- Link to Wiki references instead of duplicating content
- Keep `README.md` as a short overview pointing to Wiki

### Fixing Deployment Issues
- Check `.env` configuration (common cause of failures)
- Verify DNS & firewall rules
- Inspect Docker logs: `docker logs <container>`
- Ensure volume mounts and permissions are correct

### Adding Secrets or Config
- Only add to `.env.example` with placeholder values
- Never commit real values to `.env` or code
- Document what each variable does
- Provide generation instructions (e.g., "Use `rails secret` for SECRET_KEY_BASE")

## When NOT to Add Code

- **Large custom scripts**: Keep setup/maintenance simple or link to external scripts
- **Provider-specific integrations**: Document as optional extensions, not in core repo
- **Legacy migration guides**: Move to Wiki or separate docs, not root-level `.md` files
- **Hardcoded instances**: All configs must parameterized (use env vars)

## GitHub Actions Workflows

### `sync-wiki.yml`
- Triggers on push to `main` with changes in `docs/**`
- Syncs content to GitHub Wiki automatically
- Uses `GITHUB_TOKEN` with `contents: write` scope
- No manual Wiki edits needed; just update `docs/` and push

### `secret-scan.yml`
- Runs on every push/PR
- Scans for: `.env` file, certbot certs
- Fails build if secrets detected (good!)

## MCP (Model Context Protocol) Guidance

This repo is compatible with GitHub MCP for AI-assisted management:

- MCP can read/list repos, pull files, create issues, open PRs
- Useful for: doc updates, issue triaging, automated refactoring
- Always use a personal access token (PAT) with limited scopes
- Org access requires SSO authorization (if org enforces it)

See `docs/MCP.md` for detailed setup.

## Research & Reference Resources

When investigating Mastodon features, configuration, or troubleshooting:

### Official Mastodon Documentation
- **https://docs.joinmastodon.org/** - Authoritative source for Mastodon architecture, configuration, and administration
- Use this for understanding environment variables, service architecture, deployment best practices

### Mastodon Repository
- **https://github.com/mastodon/mastodon/releases** - Release notes, version history, breaking changes, and upgrade guides
- Check this before updating Mastodon versions to understand compatibility and migration requirements
- **https://github.com/mastodon/mastodon/issues** - Known issues, open bugs, feature requests, and community discussions
- Search for issues related to deployment problems, configuration questions, or version-specific behavior

## Versioning & Changelog

This project follows [Semantic Versioning](https://semver.org/):

- **Major version** (5.x.x): Significant architectural changes, major feature additions
- **Minor version** (x.1.x): New features, improvements, non-breaking changes
- **Patch version** (x.x.1): Bug fixes, documentation updates, minor fixes

### Current Release

- **Version:** 5.0.2
- **Released:** October 24, 2025
- **Focus:** Performance tuning and Nginx reliability improvements

### Version History

- **5.0.2** - Performance tuning (Sidekiq, Puma, streaming, PostgreSQL), Nginx dynamic DNS resolution
- **5.0.1** - Documentation reorganization, migration guides, security and performance documentation
- **5.0.0** - Initial Docker Compose implementation (5th iteration of stranger-social)

See `docs/CHANGELOG.md` for detailed changelog with:
- Added features and improvements
- Changed behavior or breaking changes
- Fixed bugs and issues
- Deprecated features

### When to Update Changelog

Add entries to `docs/CHANGELOG.md` when:
- Adding user-facing features
- Making significant improvements
- Fixing notable bugs
- Reorganizing documentation
- Updating deployment procedures
- Changing configuration requirements

Use one-liners in the "Added", "Changed", "Fixed" sections. Focus on impact, not implementation details.

## Questions for Copilot

Good questions to ask Copilot about this repo:

- "How do I deploy this on [cloud provider]?"
- "What environment variables do I need to set?"
- "How do I troubleshoot [service] not starting?"
- "How do I add support for [feature]?"
- "What's the best way to backup the database?"
- "How do I update Mastodon to the next version?"
- "Can you help me write a script to [task]?"

---

**Last Updated:** October 23, 2025  
**Current Version:** 5.0.1  
**Repository:** https://github.com/stranger-social/mastodon-docker  
**Wiki:** See `docs/` folder (auto-synced to GitHub Wiki)  
**Changelog:** See `docs/CHANGELOG.md`
